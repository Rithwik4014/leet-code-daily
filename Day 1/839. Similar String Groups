class Solution {
public:
    int numSimilarGroups(vector<string>& strs) {
        int n = strs.size();
        int m = strs[0].size();

        vector<int> parent(n), rank_(n, 0);
        iota(parent.begin(), parent.end(), 0);

        function<int(int)> find = [&](int x) {
            if (parent[x] != x) parent[x] = find(parent[x]);
            return parent[x];
        };

        auto unite = [&](int x, int y) {
            int rx = find(x), ry = find(y);
            if (rx == ry) return false;
            if (rank_[rx] < rank_[ry]) {
                parent[rx] = ry;
            } else if (rank_[rx] > rank_[ry]) {
                parent[ry] = rx;
            } else {
                parent[ry] = rx;
                rank_[rx]++;
            }
            return true;
        };

        auto isSimilar = [&](const string& a, const string& b) {
            int diff = 0;
            for (int i = 0; i < m && diff <= 2; ++i) {
                if (a[i] != b[i]) diff++;
            }
            return diff == 0 || diff == 2;
        };

        int groups = n;
        for (int i = 0; i < n; ++i) {
            for (int j = i + 1; j < n; ++j) {
                if (isSimilar(strs[i], strs[j])) {
                    if (unite(i, j)) groups--;
                }
            }
        }
        return groups;
    }
};
